<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Northeast Weather Models</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; text-align: center; }
        h1 { margin: 20px; }
        #last-updated { margin-bottom: 12px; color: #888; font-size: 0.9em; }

        .controls {
            display: flex; justify-content: center; align-items: center;
            gap: 12px; flex-wrap: wrap; margin: 0 20px 16px;
        }
        .var-tabs { display: flex; gap: 4px; }
        .var-tabs button {
            background: #333; color: #aaa; border: 1px solid #444;
            border-radius: 4px; padding: 6px 14px; cursor: pointer; font-size: 0.85em;
        }
        .var-tabs button.active { background: #4caf50; color: #fff; border-color: #4caf50; }
        .slider-group { display: flex; align-items: center; gap: 8px; }
        .slider-group label { color: #aaa; font-size: 0.85em; white-space: nowrap; }
        #frame-slider { width: 200px; accent-color: #4caf50; }
        #frame-label { color: #ccc; font-size: 0.85em; min-width: 90px; }
        .nav-btn {
            background: #333; color: #ccc; border: 1px solid #444;
            border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 1em;
        }
        .nav-btn:hover { background: #444; }
        #play-btn { min-width: 36px; }

        .grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 0 20px 30px; }
        .card {
            background: #2a2a2a; padding: 10px; border-radius: 8px;
            width: 45%; min-width: 300px;
        }
        .card img {
            width: 100%; border-radius: 4px; display: block;
            aspect-ratio: 4/3; object-fit: contain; background: #222;
        }
        .meta {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px; font-size: 0.9em; color: #aaa;
        }
        .status-ok { color: #4caf50; }
        .status-fail { color: #f44336; }
        .no-data { color: #666; font-style: italic; padding: 40px; }
    </style>
</head>
<body>
    <h1>Northeast US Weather Forecast Viewer</h1>
    <div id="last-updated"></div>

    <div class="controls">
        <div class="var-tabs" id="var-tabs"></div>
        <button class="nav-btn" id="prev-btn" title="Previous frame">&larr;</button>
        <button class="nav-btn" id="play-btn" title="Play/Pause">&#9654;</button>
        <button class="nav-btn" id="next-btn" title="Next frame">&rarr;</button>
        <div class="slider-group">
            <label for="frame-slider">Frame:</label>
            <input type="range" id="frame-slider" min="0" max="24" value="0">
            <span id="frame-label">F00 - 00:00</span>
        </div>
    </div>

    <div class="grid" id="model-grid"></div>

    <script>
        let modelData = {};
        let allVars = [];
        let currentVar = '';
        let currentFrame = 0;
        let maxFrame = 0;
        let playTimer = null;
        const modelOrder = ['hrrr', 'nam', 'nam3k', 'gfs', 'rrfs'];
        const varLabels = { temp: 'Temp', gust: 'Wind Gust', radar: 'Radar', precip: 'Precip', snow: 'Snow' };
        const cacheBuster = Date.now();

        async function loadModels() {
            try {
                const response = await fetch('status.json?t=' + cacheBuster);
                modelData = await response.json();
            } catch (e) {
                document.getElementById('model-grid').innerHTML =
                    '<p class="no-data">Could not load status.json</p>';
                return;
            }

            // Discover all available variables across all models/frames
            const varSet = new Set();
            for (const model of modelOrder) {
                if (!modelData[model] || !modelData[model].frames) continue;
                for (const frame of modelData[model].frames) {
                    for (const key of Object.keys(frame)) {
                        if (key !== 'fxx' && key !== 'valid' && frame[key] && frame[key] !== null) {
                            varSet.add(key);
                        }
                    }
                }
            }
            allVars = ['temp', 'gust', 'radar', 'snow', 'precip'].filter(v => varSet.has(v));
            if (allVars.length === 0) {
                document.getElementById('model-grid').innerHTML =
                    '<p class="no-data">No frame data available</p>';
                return;
            }
            currentVar = allVars[0];

            // Find max frame index
            maxFrame = 0;
            for (const model of modelOrder) {
                if (!modelData[model] || !modelData[model].frames) continue;
                const last = modelData[model].frames[modelData[model].frames.length - 1];
                if (last && last.fxx > maxFrame) maxFrame = last.fxx;
            }

            buildVarTabs();
            buildModelCards();
            setupSlider();
            updateView();

            document.getElementById('last-updated').innerText =
                'Last Check: ' + new Date().toLocaleString();
        }

        function buildVarTabs() {
            const container = document.getElementById('var-tabs');
            container.innerHTML = '';
            for (const v of allVars) {
                const btn = document.createElement('button');
                btn.textContent = varLabels[v] || v;
                btn.dataset.varName = v;
                if (v === currentVar) btn.classList.add('active');
                btn.addEventListener('click', () => {
                    currentVar = v;
                    container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateView();
                });
                container.appendChild(btn);
            }
        }

        function buildModelCards() {
            const grid = document.getElementById('model-grid');
            grid.innerHTML = '';
            for (const model of modelOrder) {
                if (!modelData[model] || !modelData[model].frames) continue;
                const info = modelData[model];
                const card = document.createElement('div');
                card.className = 'card';
                card.id = 'card-' + model;
                card.innerHTML = `
                    <img id="img-${model}" alt="${model}" loading="lazy"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                    <div class="meta">
                        <strong>${model.toUpperCase()}</strong>
                        <span class="status-ok">${info.run_time || ''}</span>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function setupSlider() {
            const slider = document.getElementById('frame-slider');
            slider.max = maxFrame;
            slider.value = currentFrame;
            slider.addEventListener('input', () => {
                currentFrame = parseInt(slider.value);
                updateView();
            });

            document.getElementById('prev-btn').addEventListener('click', () => {
                if (currentFrame > 0) { currentFrame--; slider.value = currentFrame; updateView(); }
            });
            document.getElementById('next-btn').addEventListener('click', () => {
                if (currentFrame < maxFrame) { currentFrame++; slider.value = currentFrame; updateView(); }
            });
            document.getElementById('play-btn').addEventListener('click', togglePlay);
        }

        function togglePlay() {
            const btn = document.getElementById('play-btn');
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
                btn.innerHTML = '&#9654;';
            } else {
                btn.innerHTML = '&#9646;&#9646;';
                playTimer = setInterval(() => {
                    currentFrame++;
                    if (currentFrame > maxFrame) currentFrame = 0;
                    document.getElementById('frame-slider').value = currentFrame;
                    updateView();
                }, 500);
            }
        }

        function updateView() {
            const fStr = 'F' + String(currentFrame).padStart(2, '0');
            let validTime = '';

            for (const model of modelOrder) {
                if (!modelData[model] || !modelData[model].frames) continue;
                const frame = modelData[model].frames.find(f => f.fxx === currentFrame);
                const img = document.getElementById('img-' + model);
                if (!img) continue;

                if (frame && frame[currentVar]) {
                    img.src = frame[currentVar] + '?t=' + cacheBuster;
                    img.alt = `${model.toUpperCase()} ${currentVar} ${fStr}`;
                    if (!validTime && frame.valid) validTime = frame.valid;
                } else {
                    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    img.alt = `${model.toUpperCase()} - no data for ${currentVar} ${fStr}`;
                }
            }

            document.getElementById('frame-label').textContent =
                fStr + (validTime ? ' - ' + validTime : '');

            // Preload adjacent frames
            preloadFrame(currentFrame + 1);
        }

        function preloadFrame(fxx) {
            if (fxx < 0 || fxx > maxFrame) return;
            for (const model of modelOrder) {
                if (!modelData[model] || !modelData[model].frames) continue;
                const frame = modelData[model].frames.find(f => f.fxx === fxx);
                if (frame && frame[currentVar]) {
                    const link = document.createElement('link');
                    link.rel = 'prefetch';
                    link.as = 'image';
                    link.href = frame[currentVar] + '?t=' + cacheBuster;
                    document.head.appendChild(link);
                }
            }
        }

        loadModels();
    </script>
</body>
</html>
